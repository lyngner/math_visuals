name: Deploy infrastructure

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-iac:
    name: Deploy CloudFormation stacks
    runs-on: ubuntu-latest
    env:
      # Required GitHub secrets for AWS access and stack configuration
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_IAC_ROLE_ARN: ${{ secrets.AWS_IAC_ROLE_ARN }}
      STATIC_SITE_BUCKET_NAME: ${{ secrets.STATIC_SITE_BUCKET_NAME }}
      STATIC_SITE_CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.STATIC_SITE_CLOUDFRONT_DISTRIBUTION_ID }}
      STATIC_SITE_API_DOMAIN: ${{ secrets.STATIC_SITE_API_DOMAIN }}
      STATIC_SITE_API_ORIGIN_PATH: ${{ secrets.STATIC_SITE_API_ORIGIN_PATH }}
      STATIC_SITE_CLOUDFRONT_PRICE_CLASS: ${{ secrets.STATIC_SITE_CLOUDFRONT_PRICE_CLASS }}
      API_ARTIFACT_BUCKET: ${{ secrets.API_ARTIFACT_BUCKET }}
      API_ARTIFACT_KEY: ${{ secrets.API_ARTIFACT_KEY }}
      API_ARTIFACT_VERSION: ${{ secrets.API_ARTIFACT_VERSION }}
      API_STAGE_NAME: ${{ secrets.API_STAGE_NAME }}
      CLOUDFRONT_INVALIDATION_PATHS: ${{ secrets.CLOUDFRONT_INVALIDATION_PATHS }}
      # Stack names and defaults
      STATIC_STACK_NAME: math-visuals-static
      API_STACK_NAME: math-visuals-api
      DATA_STACK_NAME: math-visuals-data
      DATA_ENVIRONMENT_NAME: prod
      SHARED_PARAMETERS_STACK_NAME: math-visuals-shared
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ env.AWS_IAC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy data stack
        run: |
          aws cloudformation deploy \
            --stack-name "$DATA_STACK_NAME" \
            --template-file infra/data/template.yaml \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides \
              EnvironmentName=$DATA_ENVIRONMENT_NAME

      - name: Sync shared Redis connection parameters
        env:
          REDIS_ENDPOINT: ${{ secrets.REDIS_ENDPOINT }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        run: |
          set -euo pipefail

          if [ -z "${REDIS_ENDPOINT:-}" ] || [ -z "${REDIS_PORT:-}" ] || [ -z "${REDIS_PASSWORD:-}" ]; then
            echo "Missing REDIS_* secrets. Make sure REDIS_ENDPOINT, REDIS_PORT and REDIS_PASSWORD are configured." >&2
            exit 1
          fi

          get_output() {
            local stack_name="$1"
            local output_key="$2"
            aws cloudformation describe-stacks \
              --stack-name "$stack_name" \
              --query "Stacks[0].Outputs[?OutputKey=='${output_key}'].OutputValue" \
              --output text
          }

          REDIS_PASSWORD_SECRET_NAME=$(get_output "$SHARED_PARAMETERS_STACK_NAME" RedisPasswordSecretName)
          REDIS_ENDPOINT_PARAMETER_NAME=$(get_output "$SHARED_PARAMETERS_STACK_NAME" RedisEndpointParameterName)
          REDIS_PORT_PARAMETER_NAME=$(get_output "$SHARED_PARAMETERS_STACK_NAME" RedisPortParameterName)

          if [ -z "$REDIS_PASSWORD_SECRET_NAME" ] || [ "$REDIS_PASSWORD_SECRET_NAME" == "None" ]; then
            echo "Unable to resolve RedisPasswordSecretName output from stack $SHARED_PARAMETERS_STACK_NAME" >&2
            exit 1
          fi

          if [ -z "$REDIS_ENDPOINT_PARAMETER_NAME" ] || [ "$REDIS_ENDPOINT_PARAMETER_NAME" == "None" ]; then
            echo "Unable to resolve RedisEndpointParameterName output from stack $SHARED_PARAMETERS_STACK_NAME" >&2
            exit 1
          fi

          if [ -z "$REDIS_PORT_PARAMETER_NAME" ] || [ "$REDIS_PORT_PARAMETER_NAME" == "None" ]; then
            echo "Unable to resolve RedisPortParameterName output from stack $SHARED_PARAMETERS_STACK_NAME" >&2
            exit 1
          fi

          SECRET_STRING=$(python - <<'PY'
import json, os
print(json.dumps({"authToken": os.environ["REDIS_PASSWORD"]}))
PY
)

          aws secretsmanager put-secret-value \
            --secret-id "$REDIS_PASSWORD_SECRET_NAME" \
            --secret-string "$SECRET_STRING"

          aws ssm put-parameter \
            --name "$REDIS_ENDPOINT_PARAMETER_NAME" \
            --type String \
            --value "$REDIS_ENDPOINT" \
            --overwrite

          aws ssm put-parameter \
            --name "$REDIS_PORT_PARAMETER_NAME" \
            --type String \
            --value "$REDIS_PORT" \
            --overwrite

      - name: Deploy API stack
        run: |
          aws cloudformation deploy \
            --stack-name "$API_STACK_NAME" \
            --template-file infra/api/template.yaml \
            --capabilities CAPABILITY_IAM CAPABILITY_AUTO_EXPAND \
            --parameter-overrides \
              LambdaCodeS3Bucket=$API_ARTIFACT_BUCKET \
              LambdaCodeS3Key=$API_ARTIFACT_KEY \
              LambdaCodeS3ObjectVersion=$API_ARTIFACT_VERSION \
              StageName=$API_STAGE_NAME

      - name: Deploy static site stack
        run: |
          aws cloudformation deploy \
            --stack-name "$STATIC_STACK_NAME" \
            --template-file infra/static-site/template.yaml \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides \
              SiteBucketName=$STATIC_SITE_BUCKET_NAME \
              ApiGatewayDomainName=$STATIC_SITE_API_DOMAIN \
              ApiGatewayOriginPath=$STATIC_SITE_API_ORIGIN_PATH \
              CloudFrontPriceClass=$STATIC_SITE_CLOUDFRONT_PRICE_CLASS

      - name: Invalidate CloudFront cache
        if: ${{ env.STATIC_SITE_CLOUDFRONT_DISTRIBUTION_ID != '' }}
        run: |
          PATHS="${CLOUDFRONT_INVALIDATION_PATHS:-/*}"
          aws cloudfront create-invalidation \
            --distribution-id "$STATIC_SITE_CLOUDFRONT_DISTRIBUTION_ID" \
            --paths $PATHS
