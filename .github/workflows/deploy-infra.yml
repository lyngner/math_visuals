name: Deploy infrastructure

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-iac:
    name: Deploy CloudFormation stacks
    runs-on: ubuntu-latest
    env:
      # Required GitHub secrets for AWS access and stack configuration
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_IAC_ROLE_ARN: ${{ secrets.AWS_IAC_ROLE_ARN }}
      STATIC_SITE_BUCKET_NAME: ${{ secrets.STATIC_SITE_BUCKET_NAME }}
      STATIC_SITE_CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.STATIC_SITE_CLOUDFRONT_DISTRIBUTION_ID }}
      STATIC_SITE_API_DOMAIN: ${{ secrets.STATIC_SITE_API_DOMAIN }}
      STATIC_SITE_API_ORIGIN_PATH: ${{ secrets.STATIC_SITE_API_ORIGIN_PATH }}
      STATIC_SITE_CLOUDFRONT_PRICE_CLASS: ${{ secrets.STATIC_SITE_CLOUDFRONT_PRICE_CLASS }}
      API_ARTIFACT_BUCKET: ${{ secrets.API_ARTIFACT_BUCKET }}
      API_ARTIFACT_KEY: ${{ secrets.API_ARTIFACT_KEY }}
      API_ARTIFACT_VERSION: ${{ secrets.API_ARTIFACT_VERSION }}
      API_STAGE_NAME: ${{ secrets.API_STAGE_NAME }}
      DATA_KV_REST_API_URL: ${{ secrets.DATA_KV_REST_API_URL }}
      DATA_KV_REST_API_TOKEN: ${{ secrets.DATA_KV_REST_API_TOKEN }}
      FIGURE_LIBRARY_KV_REST_API_URL: ${{ secrets.FIGURE_LIBRARY_KV_REST_API_URL }}
      FIGURE_LIBRARY_KV_REST_API_TOKEN: ${{ secrets.FIGURE_LIBRARY_KV_REST_API_TOKEN }}
      CLOUDFRONT_INVALIDATION_PATHS: ${{ secrets.CLOUDFRONT_INVALIDATION_PATHS }}
      # Stack names and defaults
      STATIC_STACK_NAME: math-visuals-static
      API_STACK_NAME: math-visuals-api
      DATA_STACK_NAME: math-visuals-data
      DATA_ENVIRONMENT_NAME: prod
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ env.AWS_IAC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy data stack
        run: |
          aws cloudformation deploy \
            --stack-name "$DATA_STACK_NAME" \
            --template-file infra/data/template.yaml \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides \
              EnvironmentName=$DATA_ENVIRONMENT_NAME \
              KvRestApiUrl=$DATA_KV_REST_API_URL \
              KvRestApiToken=$DATA_KV_REST_API_TOKEN \
              FigureLibraryKvRestApiUrl=$FIGURE_LIBRARY_KV_REST_API_URL \
              FigureLibraryKvRestApiToken=$FIGURE_LIBRARY_KV_REST_API_TOKEN

      - name: Deploy API stack
        run: |
          aws cloudformation deploy \
            --stack-name "$API_STACK_NAME" \
            --template-file infra/api/template.yaml \
            --capabilities CAPABILITY_IAM CAPABILITY_AUTO_EXPAND \
            --parameter-overrides \
              LambdaCodeS3Bucket=$API_ARTIFACT_BUCKET \
              LambdaCodeS3Key=$API_ARTIFACT_KEY \
              LambdaCodeS3ObjectVersion=$API_ARTIFACT_VERSION \
              StageName=$API_STAGE_NAME

      - name: Deploy static site stack
        run: |
          aws cloudformation deploy \
            --stack-name "$STATIC_STACK_NAME" \
            --template-file infra/static-site/template.yaml \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides \
              SiteBucketName=$STATIC_SITE_BUCKET_NAME \
              ApiGatewayDomainName=$STATIC_SITE_API_DOMAIN \
              ApiGatewayOriginPath=$STATIC_SITE_API_ORIGIN_PATH \
              CloudFrontPriceClass=$STATIC_SITE_CLOUDFRONT_PRICE_CLASS

      - name: Invalidate CloudFront cache
        if: ${{ env.STATIC_SITE_CLOUDFRONT_DISTRIBUTION_ID != '' }}
        run: |
          PATHS="${CLOUDFRONT_INVALIDATION_PATHS:-/*}"
          aws cloudfront create-invalidation \
            --distribution-id "$STATIC_SITE_CLOUDFRONT_DISTRIBUTION_ID" \
            --paths $PATHS
