AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  Stores Vercel KV REST API configuration in AWS Secrets Manager and Systems
  Manager Parameter Store so that the Math Visuals API can fetch credentials
  during deployment.

Parameters:
  EnvironmentName:
    Type: String
    Description: Environment name used as a prefix for resource paths (e.g. prod).
  KvRestApiUrl:
    Type: String
    Description: Base URL for the primary Vercel KV REST API instance.
  KvRestApiToken:
    Type: String
    NoEcho: true
    Description: Write token for the primary Vercel KV instance.
  FigureLibraryKvRestApiUrl:
    Type: String
    Description: Base URL for the figure library Vercel KV REST API instance.
  FigureLibraryKvRestApiToken:
    Type: String
    NoEcho: true
    Description: Write token for the figure library Vercel KV instance.
  SharedParametersStackName:
    Type: String
    Description: Name of the CloudFormation stack that exports shared parameter names.

Resources:
  ExamplesKvRestApiUrlParameter:
    Type: AWS::SSM::Parameter
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      Name: !Sub '/math-visuals/${EnvironmentName}/examples/kv-rest-api-url'
      Type: String
      Value: !Ref KvRestApiUrl
      Description: Base URL for the Vercel KV instance used by /api/examples.

  ExamplesKvRestApiTokenSecret:
    Type: AWS::SecretsManager::Secret
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      Name: !Sub 'math-visuals/${EnvironmentName}/examples/kv-rest-api-token'
      Description: Write token for the Vercel KV instance used by /api/examples.
      SecretString: !Ref KvRestApiToken

  FigureLibraryKvRestApiUrlParameter:
    Type: AWS::SSM::Parameter
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      Name: !Sub '/math-visuals/${EnvironmentName}/figure-library/kv-rest-api-url'
      Type: String
      Value: !Ref FigureLibraryKvRestApiUrl
      Description: Base URL for the Vercel KV instance used by /api/figure-library.

  FigureLibraryKvRestApiTokenSecret:
    Type: AWS::SecretsManager::Secret
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      Name: !Sub 'math-visuals/${EnvironmentName}/figure-library/kv-rest-api-token'
      Description: Write token for the Vercel KV instance used by /api/figure-library.
      SecretString: !Ref FigureLibraryKvRestApiToken

Outputs:
  ExamplesKvRestApiUrlParameterArn:
    Description: ARN to the SSM parameter storing the /api/examples KV REST API URL.
    Value: !GetAtt ExamplesKvRestApiUrlParameter.Arn
  ExamplesKvRestApiTokenSecretArn:
    Description: ARN to the secret storing the /api/examples KV REST API token.
    Value: !Ref ExamplesKvRestApiTokenSecret
  FigureLibraryKvRestApiUrlParameterArn:
    Description: ARN to the SSM parameter storing the /api/figure-library KV REST API URL.
    Value: !GetAtt FigureLibraryKvRestApiUrlParameter.Arn
  FigureLibraryKvRestApiTokenSecretArn:
    Description: ARN to the secret storing the /api/figure-library KV REST API token.
    Value: !Ref FigureLibraryKvRestApiTokenSecret
  RedisPasswordSecretName:
    Description: Shared Secrets Manager secret name used for the Redis password/auth token.
    Value: !ImportValue
      Fn::Sub: '${SharedParametersStackName}-RedisPasswordSecretName'
  RedisEndpointParameterName:
    Description: Shared SSM parameter name that stores the Redis endpoint.
    Value: !ImportValue
      Fn::Sub: '${SharedParametersStackName}-RedisEndpointParameterName'
  RedisPortParameterName:
    Description: Shared SSM parameter name that stores the Redis port.
    Value: !ImportValue
      Fn::Sub: '${SharedParametersStackName}-RedisPortParameterName'
