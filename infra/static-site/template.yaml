AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  CloudFormation template provisioning a versioned S3 bucket and CloudFront distribution
  for the math visuals static site, routing selected paths to an API Gateway origin.

Parameters:
  SiteBucketName:
    Type: String
    Description: Globally-unique name for the S3 bucket hosting the static site.
  ApiGatewayDomainName:
    Type: String
    Description: >-
      Fully-qualified domain name of the API Gateway stage (for example,
      a1b2c3d4.execute-api.us-east-1.amazonaws.com).
  ApiGatewayOriginPath:
    Type: String
    Default: /prod
    Description: Optional origin path appended to the API Gateway domain (e.g., /prod).
  CloudFrontPriceClass:
    Type: String
    Default: PriceClass_100
    AllowedValues:
      - PriceClass_100
      - PriceClass_200
      - PriceClass_All
    Description: Price class to use for the CloudFront distribution.
  SharedParametersStackName:
    Type: String
    Description: Name of the CloudFormation stack that exports shared parameter names.

Resources:
  SiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref SiteBucketName
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  CloudFrontOriginAccessIdentity:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: Access identity for math visuals static assets bucket

  SiteBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref SiteBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowCloudFrontServicePrincipalReadOnly
            Effect: Allow
            Principal:
              CanonicalUser: !GetAtt CloudFrontOriginAccessIdentity.S3CanonicalUserId
            Action:
              - s3:GetObject
            Resource: !Sub '${SiteBucket.Arn}/*'

  ViewerRequestRouterFunction:
    Type: AWS::CloudFront::Function
    Properties:
      Name: !Sub '${AWS::StackName}-viewer-router'
      AutoPublish: true
      FunctionConfig:
        Comment: Rewrite friendly routes to their HTML assets
        Runtime: cloudfront-js-1.0
      FunctionCode: |
        'use strict';

        function normalizeAlias(value) {
          if (typeof value !== 'string' || !value) {
            return null;
          }
          var alias = value;
          if (alias.charCodeAt(0) !== 47) {
            alias = '/' + alias;
          }
          alias = alias.toLowerCase();
          if (alias.length > 1 && alias.charCodeAt(alias.length - 1) === 47) {
            alias = alias.slice(0, -1);
          }
          return alias;
        }

        function matchesBase(uri, base) {
          if (uri === base) {
            return true;
          }
          if (base === '/') {
            return uri === '/' || uri === '';
          }
          if (uri.length === base.length + 1 && uri.startsWith(base) && uri.charCodeAt(base.length) === 47) {
            return true;
          }
          return false;
        }

        function isDigit(code) {
          return code >= 48 && code <= 57;
        }

        function matchesExample(uri, base) {
          if (!uri.startsWith(base)) {
            return false;
          }
          var remainder = uri.slice(base.length);
          if (!remainder || remainder.charCodeAt(0) !== 47) {
            return false;
          }
          remainder = remainder.slice(1);
          if (!remainder) {
            return false;
          }
          if (remainder.charCodeAt(remainder.length - 1) === 47) {
            remainder = remainder.slice(0, -1);
          }
          if (remainder.length < 9) {
            return false;
          }
          var lowered = remainder.toLowerCase();
          if (lowered.slice(0, 8) !== 'eksempel') {
            return false;
          }
          var suffix = remainder.slice(8);
          if (!suffix) {
            return false;
          }
          var first = suffix.charCodeAt(0);
          if (first === 45 || first === 95) {
            suffix = suffix.slice(1);
          }
          if (!suffix) {
            return false;
          }
          for (var index = 0; index < suffix.length; index++) {
            if (!isDigit(suffix.charCodeAt(index))) {
              return false;
            }
          }
          return true;
        }

        function getAssetRoot(target, override) {
          if (typeof override === 'string' && override) {
            return override;
          }
          if (typeof target !== 'string' || !target) {
            return '/';
          }
          var lastSlash = target.lastIndexOf('/');
          if (lastSlash <= 0) {
            return '/';
          }
          return target.slice(0, lastSlash + 1);
        }

        function handler(event) {
          var request = event && event.request ? event.request : null;
          if (!request || typeof request.uri !== 'string') {
            return request;
          }

          var uri = request.uri;
          if (!uri) {
            return request;
          }

          var lowerUri = uri.toLowerCase();
          var routes = [
            { target: '/graftegner.html', aliases: ['/graftegner'], includeExamples: true },
            { target: '/nkant.html', aliases: ['/nkant'], includeExamples: true },
            { target: '/diagram/index.html', aliases: ['/diagram'], includeExamples: true },
            { target: '/brøkpizza.html', aliases: ['/br%C3%B8kpizza', '/brkpizza'], includeExamples: true },
            { target: '/brøkfigurer.html', aliases: ['/br%C3%B8kfigurer', '/brkfigurer'], includeExamples: true },
            { target: '/figurtall.html', aliases: ['/figurtall'], includeExamples: true },
            { target: '/tenkeblokker.html', aliases: ['/tenkeblokker'], includeExamples: true },
            { target: '/arealmodell.html', aliases: ['/arealmodell'], includeExamples: true },
            { target: '/tallinje.html', aliases: ['/tallinje'], includeExamples: true },
            { target: '/perlesnor.html', aliases: ['/perlesnor'], includeExamples: true },
            { target: '/kuler.html', aliases: ['/kuler'], includeExamples: true },
            { target: '/kvikkbilder.html', aliases: ['/kvikkbilder'], includeExamples: true },
            { target: '/trefigurer.html', aliases: ['/trefigurer', '/3dfigurer'], includeExamples: true },
            { target: '/brøkvegg.html', aliases: ['/br%C3%B8kvegg', '/brkvegg'], includeExamples: true },
            { target: '/måling.html', aliases: ['/m%C3%A5ling', '/malingbeta'], includeExamples: false },
            { target: '/sortering.html', aliases: ['/sortering', '/sorteringbeta'], includeExamples: true },
            { target: '/prikktilprikk.html', aliases: ['/prikktilprikk', '/prikktilprikkbeta'], includeExamples: true },
            { target: '/fortegnsskjema.html', aliases: ['/fortegnsskjema', '/fortegnsskjemaunderutvikling'], includeExamples: true },
            { target: '/bibliotek.html', aliases: ['/bibliotek', '/bibliotekbeta'], includeExamples: true },
            { target: '/svg-arkiv.html', aliases: ['/svg-arkiv', '/eksempelarkiv'], includeExamples: false },
            { target: '/settings.html', aliases: ['/settings'], includeExamples: false }
          ];

          for (var i = 0; i < routes.length; i++) {
            var route = routes[i];
            var aliases = route.aliases;
            var assetRoot = getAssetRoot(route.target, route.assetRoot);
            for (var j = 0; j < aliases.length; j++) {
              var normalized = normalizeAlias(aliases[j]);
              if (!normalized) {
                continue;
              }
              if (matchesBase(lowerUri, normalized)) {
                request.uri = route.target;
                return request;
              }
              if (route.includeExamples && matchesExample(lowerUri, normalized)) {
                request.uri = route.target;
                return request;
              }
              if (lowerUri.length > normalized.length && lowerUri.startsWith(normalized) && lowerUri.charCodeAt(normalized.length) === 47) {
                var remainder = request.uri.slice(normalized.length + 1);
                if (!remainder || remainder.indexOf('.') === -1) {
                  continue;
                }
                request.uri = assetRoot + remainder;
                return request;
              }
            }
          }

          return request;
        }

  Distribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        PriceClass: !Ref CloudFrontPriceClass
        DefaultRootObject: index.html
        HttpVersion: http2
        Origins:
          - Id: SiteBucketOrigin
            DomainName: !GetAtt SiteBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: !Sub 'origin-access-identity/cloudfront/${CloudFrontOriginAccessIdentity}'
          - Id: ApiGatewayOrigin
            DomainName: !Ref ApiGatewayDomainName
            OriginPath: !Ref ApiGatewayOriginPath
            CustomOriginConfig:
              OriginProtocolPolicy: https-only
              OriginSSLProtocols:
                - TLSv1.2
              HTTPPort: 80
              HTTPSPort: 443
        DefaultCacheBehavior:
          TargetOriginId: SiteBucketOrigin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
          Compress: true
          FunctionAssociations:
            - EventType: viewer-request
              FunctionARN: !GetAtt ViewerRequestRouterFunction.FunctionARN
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
        CacheBehaviors:
          - PathPattern: '/sortering*'
            TargetOriginId: SiteBucketOrigin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
            Compress: true
            ForwardedValues:
              QueryString: true
              Cookies:
                Forward: none
          - PathPattern: '/bildearkiv/*'
            TargetOriginId: ApiGatewayOrigin
            ViewerProtocolPolicy: https-only
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
            Compress: true
            ForwardedValues:
              QueryString: true
              Cookies:
                Forward: none
          - PathPattern: '/svg/*'
            TargetOriginId: ApiGatewayOrigin
            ViewerProtocolPolicy: https-only
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
            Compress: true
            ForwardedValues:
              QueryString: true
              Cookies:
                Forward: none
          - PathPattern: '/figure-library/*'
            TargetOriginId: ApiGatewayOrigin
            ViewerProtocolPolicy: https-only
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
            Compress: true
            ForwardedValues:
              QueryString: true
              Cookies:
                Forward: none
        ViewerCertificate:
          CloudFrontDefaultCertificate: true

Outputs:
  StaticSiteBucketName:
    Description: Name of the S3 bucket hosting the static site artifacts.
    Value: !Ref SiteBucket
    Export:
      Name: !Sub '${AWS::StackName}-StaticSiteBucketName'
  CloudFrontDistributionId:
    Description: Identifier of the CloudFront distribution serving the site.
    Value: !Ref Distribution
    Export:
      Name: !Sub '${AWS::StackName}-DistributionId'
  CloudFrontDistributionDomainName:
    Description: Domain name of the CloudFront distribution.
    Value: !GetAtt Distribution.DomainName
    Export:
      Name: !Sub '${AWS::StackName}-DistributionDomainName'
  ExamplesAllowedOriginsParameterName:
    Description: Name of the shared SSM parameter used for EXAMPLES_ALLOWED_ORIGINS.
    Value: !ImportValue
      Fn::Sub: '${SharedParametersStackName}-ExamplesAllowedOriginsParameterName'
  SvgAllowedOriginsParameterName:
    Description: Name of the shared SSM parameter used for SVG_ALLOWED_ORIGINS.
    Value: !ImportValue
      Fn::Sub: '${SharedParametersStackName}-SvgAllowedOriginsParameterName'
