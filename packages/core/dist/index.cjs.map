{"version":3,"file":"index.cjs","sources":["../src/eventBus.js","../src/validation.js","../src/host.js","../src/defineApp.js"],"sourcesContent":["/**\n * Creates a minimal event bus for communication between Math Visuals apps\n * and their hosts.\n *\n * @returns {{ emit: (type: string, payload?: any) => void, on: (type: string, handler: (payload: any) => void) => () => void }}\n */\nexport function createEventBus() {\n  /** @type {Map<string, Set<Function>>} */\n  const listeners = new Map();\n\n  return {\n    emit(type, payload) {\n      if (!listeners.has(type)) {\n        return;\n      }\n\n      for (const handler of listeners.get(type)) {\n        try {\n          handler(payload);\n        } catch (error) {\n          setTimeout(() => {\n            throw error;\n          });\n        }\n      }\n    },\n    on(type, handler) {\n      if (!listeners.has(type)) {\n        listeners.set(type, new Set());\n      }\n\n      listeners.get(type).add(handler);\n\n      return () => {\n        const handlers = listeners.get(type);\n        if (!handlers) return;\n        handlers.delete(handler);\n        if (handlers.size === 0) {\n          listeners.delete(type);\n        }\n      };\n    }\n  };\n}\n","const IDENTIFIER_PATTERN = /^[a-z0-9\\-]+$/i;\n\n/**\n * Validates the identifier and throws an informative error if invalid.\n *\n * @param {string} id\n */\nexport function assertValidIdentifier(id) {\n  if (typeof id !== 'string' || id.trim().length === 0) {\n    throw new TypeError('An app id must be a non-empty string.');\n  }\n\n  if (!IDENTIFIER_PATTERN.test(id)) {\n    throw new TypeError(\n      `Invalid app id \"${id}\". Use only alphanumeric characters or hyphen.`\n    );\n  }\n}\n\n/**\n * Ensures that a value is a function.\n *\n * @param {unknown} value\n * @param {string} name\n */\nexport function assertFunction(value, name) {\n  if (typeof value !== 'function') {\n    throw new TypeError(`${name} must be a function.`);\n  }\n}\n\n/**\n * Creates a deeply frozen clone of the provided object.\n *\n * @template T\n * @param {T} value\n * @returns {T}\n */\nexport function deepFreeze(value) {\n  if (value && typeof value === 'object') {\n    Object.freeze(value);\n    for (const key of Object.keys(value)) {\n      // @ts-ignore - index signature not guaranteed\n      deepFreeze(value[key]);\n    }\n  }\n  return value;\n}\n","import { createEventBus } from './eventBus.js';\nimport { assertFunction } from './validation.js';\n\n/**\n * @typedef {Object} AppContext\n * @property {ReturnType<typeof createEventBus>} bus - Shared event bus for the host and app.\n * @property {Record<string, unknown>} [environment] - Optional environment specific data.\n */\n\n/**\n * @typedef {Object} AppLifecycle\n * @property {(target: HTMLElement, payload?: unknown) => void} mount - Called when the app should render itself.\n * @property {(payload: unknown) => void} [update] - Called when the host wants to push new data to the app.\n * @property {() => void} [unmount] - Called before the app is removed from the DOM.\n */\n\n/**\n * @typedef {Object} MountedApp\n * @property {(payload: unknown) => void} update - Pushes new data into the app.\n * @property {() => void} teardown - Removes the app and runs the unmount lifecycle.\n */\n\n/**\n * Creates a host capable of mounting Math Visuals apps inside an HTMLElement.\n *\n * @param {{ onError?: (error: unknown) => void }} [options]\n */\nexport function createAppHost(options = {}) {\n  const { onError } = options;\n  const bus = createEventBus();\n\n  /** @type {null | (() => void)} */\n  let activeTeardown = null;\n\n  function handleError(error) {\n    if (typeof onError === 'function') {\n      onError(error);\n    } else {\n      console.error(error);\n    }\n  }\n\n  return {\n    bus,\n    /**\n     * @param {{ create: (context: AppContext) => AppLifecycle }} app\n     * @param {{ target: HTMLElement, payload?: unknown, environment?: Record<string, unknown> }} options\n     * @returns {MountedApp}\n     */\n    mount(app, { target, payload, environment } = {}) {\n      if (!app || typeof app.create !== 'function') {\n        throw new TypeError('A valid app with a create(context) method is required.');\n      }\n\n      if (!target || typeof target !== 'object') {\n        throw new TypeError('A valid target HTMLElement is required for mounting.');\n      }\n\n      if (activeTeardown) {\n        activeTeardown();\n        activeTeardown = null;\n      }\n\n      const lifecycle = app.create({\n        bus,\n        environment: environment || {}\n      });\n\n      assertFunction(lifecycle.mount, 'app.lifecycle.mount');\n\n      const update = lifecycle.update\n        ? (next) => {\n            lifecycle.update(next);\n          }\n        : () => {\n            throw new Error('This app does not implement lifecycle.update');\n          };\n\n      activeTeardown = () => {\n        if (typeof lifecycle.unmount === 'function') {\n          try {\n            lifecycle.unmount();\n          } catch (error) {\n            handleError(error);\n          }\n        }\n        activeTeardown = null;\n      };\n\n      try {\n        lifecycle.mount(target, payload);\n      } catch (error) {\n        activeTeardown();\n        handleError(error);\n        throw error;\n      }\n\n      return {\n        update,\n        teardown() {\n          if (activeTeardown) {\n            activeTeardown();\n          }\n        }\n      };\n    }\n  };\n}\n","import { assertFunction, assertValidIdentifier, deepFreeze } from './validation.js';\n\n/**\n * @typedef {Object} MathVisualAppDefinition\n * @property {string} id - Unique identifier for the app.\n * @property {string} title - Human readable title.\n * @property {string} [version] - Semantic version for the app implementation.\n * @property {Record<string, unknown>} [metadata] - Arbitrary metadata describing the app.\n * @property {(context: import('./host.js').AppContext) => import('./host.js').AppLifecycle} create -\n *  Factory that creates lifecycle hooks for an app instance.\n */\n\n/**\n * Defines a Math Visuals application in a type-safe manner, validating the\n * essential contract up front.\n *\n * @param {MathVisualAppDefinition} definition\n */\nexport function defineMathVisualApp(definition) {\n  if (!definition || typeof definition !== 'object') {\n    throw new TypeError('An app definition must be an object.');\n  }\n\n  const { id, title, version = '0.1.0', metadata = {}, create } = definition;\n\n  assertValidIdentifier(id);\n\n  if (typeof title !== 'string' || title.trim().length === 0) {\n    throw new TypeError('An app title must be a non-empty string.');\n  }\n\n  assertFunction(create, 'definition.create');\n\n  const frozenMetadata = deepFreeze({ ...metadata });\n\n  return Object.freeze({\n    id,\n    title,\n    version,\n    metadata: frozenMetadata,\n    create(context) {\n      const lifecycle = create({\n        ...context,\n        app: {\n          id,\n          title,\n          version,\n          metadata: frozenMetadata\n        }\n      });\n\n      if (!lifecycle || typeof lifecycle !== 'object') {\n        throw new TypeError('App factory must return an object with lifecycle hooks.');\n      }\n\n      assertFunction(lifecycle.mount, 'lifecycle.mount');\n\n      if (lifecycle.update && typeof lifecycle.update !== 'function') {\n        throw new TypeError('lifecycle.update must be a function when provided.');\n      }\n\n      if (lifecycle.unmount && typeof lifecycle.unmount !== 'function') {\n        throw new TypeError('lifecycle.unmount must be a function when provided.');\n      }\n\n      return lifecycle;\n    }\n  });\n}\n"],"names":[],"mappings":"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"}